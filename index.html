<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Management</title>
    <style>
        /* ... (your existing styles) ... */
        .note-input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body>
    <h1 class="title">[ADMIRAL.]</h1>
    <h2 class="subtitle">Company Vehicle (CV) Tracking Software</h2>
    <div class="button-container">
        <button id="undo-button">Undo</button>
        <button id="clear-button">Clear All</button>
    </div>
    <table>
        <thead>
            <tr>
                <th>Save Information</th>
                <th>Status</th>
                <th>Vehicle Name</th>
                <th>Site Assignment</th>
                <th>Usage Times</th>
                <th class="note-header" style="display:none;">Note</th> <!-- Hidden Note Column -->
            </tr>
        </thead>
        <tbody id="vehicle-table-body">
            <!-- Rows will be added here by JavaScript -->
        </tbody>
    </table>
    <button id="send-status-update">Send Status Update</button>
    <div id="clipboard-notification" class="notification"></div>
    <script>
        const vehicles = [
            "CV #002", "CV #003", "CV #004", "CV #005", "CV #006",
            "CV #007", "CV #008", "CV #009", "CV #010", "CV #011",
            "CV #012", "CV #014", "CV #015", "CV #016", "CV #017",
            "CV #018"
        ];

        const statuses = ["--", "AVAILABLE", "IN USE", "OUT OF ORDER"];
        let previousState = [];

        function createDropdown(options, selectedOption) {
            const dropdown = document.createElement('select');
            dropdown.className = 'dropdown';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (option === selectedOption) {
                    optionElement.selected = true;
                }
                dropdown.appendChild(optionElement);
            });
            return dropdown;
        }

        function populateTable() {
            const tableBody = document.getElementById('vehicle-table-body');
            vehicles.forEach((vehicle, index) => {
                const row = document.createElement('tr');

                // Save Button
                const actionsCell = document.createElement('td');
                actionsCell.className = 'actions-cell';
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.className = 'save-button';
                saveButton.disabled = true;
                saveButton.onclick = () => saveRow(index, statusCell, assignmentInput, usageInput, noteInput);
                actionsCell.appendChild(saveButton);
                row.appendChild(actionsCell);

                // Status
                const statusCell = document.createElement('td');
                const savedStatus = localStorage.getItem(`vehicle-${index}-status`) || "--";
                const dropdown = createDropdown(statuses, savedStatus);
                dropdown.addEventListener('change', () => {
                    updateRowColor(row, dropdown.value);
                    toggleNoteColumn(row, dropdown.value);
                    checkForChanges(index, dropdown.value, assignmentInput.value, usageInput.value, noteInput.value);
                });
                statusCell.appendChild(dropdown);
                row.appendChild(statusCell);

                // Vehicle Name
                const vehicleCell = document.createElement('td');
                vehicleCell.textContent = vehicle;
                row.appendChild(vehicleCell);

                // Site Assignment
                const assignmentCell = document.createElement('td');
                const assignmentInput = document.createElement('input');
                assignmentInput.type = 'text';
                assignmentInput.placeholder = 'Enter assigned site';
                assignmentInput.value = localStorage.getItem(`vehicle-${index}-assignment`) || "";
                assignmentInput.addEventListener('input', () => checkForChanges(index, dropdown.value, assignmentInput.value, usageInput.value, noteInput.value));
                assignmentCell.appendChild(assignmentInput);
                row.appendChild(assignmentCell);

                // Usage Times
                const usageCell = document.createElement('td');
                const usageInput = document.createElement('input');
                usageInput.type = 'text';
                usageInput.placeholder = 'Enter usage times';
                usageInput.value = localStorage.getItem(`vehicle-${index}-usage`) || "";
                usageInput.addEventListener('input', () => checkForChanges(index, dropdown.value, assignmentInput.value, usageInput.value, noteInput.value));
                usageCell.appendChild(usageInput);
                row.appendChild(usageCell);

                // Note Field (Hidden by default)
                const noteCell = document.createElement('td');
                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'note-input'; // Initially hidden
                noteInput.placeholder = 'Enter reason vehicle is out of order';
                noteCell.appendChild(noteInput);
                row.appendChild(noteCell);

                // Highlight row and toggle note field based on saved status
                updateRowColor(row, savedStatus);
                toggleNoteColumn(row, savedStatus);

                tableBody.appendChild(row);
            });

            previousState = Array.from(document.querySelectorAll('#vehicle-table-body tr')).map(row => ({
                status: row.querySelector('select').value,
                assignment: row.querySelector('input[placeholder="Enter assigned site"]').value,
                usage: row.querySelector('input[placeholder="Enter usage times"]').value,
                note: row.querySelector('.note-input') ? row.querySelector('.note-input').value : ""
            }));
        }

        function updateRowColor(row, status) {
            row.classList.remove('status-available', 'status-in-use', 'status-out-of-order');
            if (status === 'AVAILABLE') {
                row.classList.add('status-available');
            } else if (status === 'IN USE') {
                row.classList.add('status-in-use');
            } else if (status === 'OUT OF ORDER') {
                row.classList.add('status-out-of-order');
            }
        }

        function toggleNoteColumn(row, status) {
            const noteHeader = document.querySelector('.note-header');
            const noteInput = row.querySelector('.note-input');

            if (status === 'OUT OF ORDER') {
                noteInput.style.display = 'block'; // Show the note field
                noteHeader.style.display = 'table-cell'; // Show the Note column header
            } else {
                noteInput.style.display = 'none'; // Hide the note field
                noteHeader.style.display = 'none'; // Hide the Note column header
            }
        }

        function checkForChanges(index, status, assignment, usage, note) {
            const saveButton = document.querySelectorAll('.save-button')[index];
            if (status !== previousState[index].status || 
                assignment !== previousState[index].assignment || 
                usage !== previousState[index].usage ||
                note !== previousState[index].note) {
                saveButton.classList.add('enabled');
                saveButton.disabled = false;
            } else {
                saveButton.classList.remove('enabled');
                saveButton.disabled = true;
            }
        }

        function saveRow(index, statusCell, assignmentInput, usageInput, noteInput) {
            const saveButton = document.querySelectorAll('.save-button')[index];
            const status = statusCell.querySelector('select').value;
            const assignment = assignmentInput.value;
            const usage = usageInput.value;
            const note = noteInput.value;

            localStorage.setItem(`vehicle-${index}-status`, status);
            localStorage.setItem(`vehicle-${index}-assignment`, assignment);
            localStorage.setItem(`vehicle-${index}-usage`, usage);
            if (status === 'OUT OF ORDER') {
                localStorage.setItem(`vehicle-${index}-note`, note);
            }

            previousState[index] = { status, assignment, usage, note };
            saveButton.classList.remove('enabled');
            saveButton.disabled = true;

            showClipboardNotification('Status update saved!');
        }

        document.addEventListener('DOMContentLoaded', populateTable);
    </script>
</body>
</html>
